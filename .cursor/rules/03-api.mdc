---
description: Padroes da camada API - client, modulos e tipos
globs: ["src/api/**"]
alwaysApply: false
---

# API Layer - Padroes CORRETOS

## Client (`api/client.ts`)

- Axios instance com `baseURL` de `VITE_API_URL`
- Request interceptor: `Authorization: Bearer <token>` de localStorage
- Response interceptor: erro tratado com `ERROR_HANDLERS` de `@/lib/errorCodes`, toast.error, redirect/logout
- NUNCA modificar o client sem entender o fluxo de erro global

## Modulos (um arquivo por dominio)

```tsx
import { api } from './client'
import type { X, PaginatedResponse } from '@/types'

export async function listX(params?: ListXParams): Promise<PaginatedResponse<X>> {
  const { data } = await api.get<PaginatedResponse<X>>('/x', { params })
  return data
}

export async function createX(payload: CreateXPayload) {
  const { data } = await api.post<X>('/x', payload)
  return data
}

export async function updateX(id: string, payload: UpdateXPayload) {
  const { data } = await api.patch<X>(`/x/${id}`, payload)
  return data
}

export async function deleteX(id: string) {
  await api.delete(`/x/${id}`)  // 204 sem body — NUNCA retornar data
}
```

## Soft Delete / Restore / Lixeira

```tsx
export async function listDeletedX(params: { page: number; limit: number }): Promise<PaginatedResponse<X>> {
  const { data } = await api.get<PaginatedResponse<X>>('/x/deleted', { params })
  return data
}

export async function restoreX(id: string) {
  const { data } = await api.patch<X>(`/x/${id}/restore`)
  return data
}
```

## Modulos existentes

- **CRUD admin**: `users.ts`, `schools.ts`, `courses.ts`, `seasons.ts`, `classes.ts`
- **Templates**: `templates.ts` (multi-entidade: ProjectTemplate, TrackSceneTemplate, TrackMaterialTemplate, StudyTrackCategory, StudyTrackTemplate, PressQuizTemplate)
- **Daily missions**: `dailyMissions.ts` (DailyMissionTemplate + DailyMissionQuiz)
- **Instances**: `instances.ts` (Project, TrackScene, TrackMaterial, StudyTrack, PressQuiz)
- **Auth/profile**: `auth.ts`, `profiles.ts`
- **Infra**: `storage.ts`, `media.ts`, `notifications.ts`, `dashboard.ts`
- **AI**: `ai.ts` (geracao de conteudo com IA)

## Convencoes

- Naming: `listX`, `getX`, `createX`, `updateX`, `deleteX`, `restoreX`, `listDeletedX`, verbos especificos (`suspendUser`, `restoreUser`)
- Payload types: `interface` no mesmo arquivo (`CreateXPayload`, `UpdateXPayload`, `ListXParams`)
- Response types: importar de `@/types` (`X`, `PaginatedResponse<X>`)
- DELETE retorna void (backend envia 204) — NUNCA `const { data } = await api.delete(...)`
- PATCH/POST retorna o objeto atualizado
- NUNCA try/catch nos modulos (interceptor global cuida)
- Multi-entidade: `templates.ts` agrupa sub-entidades de templates em um unico arquivo (exceção ao padrao de um arquivo por recurso)

## Tratamento de erro 409 (deactivation blocked)

Nas pages, quando o delete retorna 409, capturar `details` no `onError`:
```tsx
onError: (error: unknown) => {
  const axiosError = error as { response?: { status?: number; data?: { details?: DeactivationErrorDetails } } }
  if (axiosError.response?.status === 409 && axiosError.response.data?.details) {
    setBlockedInfo({ ... })
  }
}
```
NUNCA usar `error: any` — sempre `error: unknown` com type assertion.

## Backend Reference (`c:\Users\eduar\Documents\claveBack`)

### Padrao REST do Backend

| Metodo | Status | Body de resposta | Funcao frontend |
|--------|--------|------------------|-----------------|
| POST | 201 | Objeto criado (DTO) | `const { data } = await api.post<T>()` |
| GET | 200 | Objeto(s) ou paginado | `const { data } = await api.get<T>()` |
| PATCH | 200 | Objeto atualizado (DTO) | `const { data } = await api.patch<T>()` |
| DELETE | 204 | Sem body | `await api.delete()` (void) |

### Endpoints padrao por recurso

- `POST /x` — criar (201)
- `GET /x` — listar ativos (200, paginado com `?page=&limit=`)
- `GET /x/:id` — buscar por ID (200)
- `PATCH /x/:id` — atualizar (200)
- `DELETE /x/:id` — soft delete (204)
- `GET /x/deleted` — listar inativos/lixeira (200, paginado)
- `PATCH /x/:id/restore` — restaurar (200)

### Formato de paginacao

`?page=1&limit=10` retorna `{ data: T[], pagination: { page, limit, total, totalPages } }`

### Formato de erro

`{ error: string, code: string, details?: object }` — `code` mapeado em `@/lib/errorCodes.ts`

### Como verificar endpoints

- Rules: `c:\Users\eduar\Documents\claveBack\.cursor\rules\03-infrastructure.md`
- Routes: `c:\Users\eduar\Documents\claveBack\src\infrastructure\routes\`
- DTOs: `c:\Users\eduar\Documents\claveBack\src\application\dto\`
